# ğŸš€ DigitalOcean ì„œë²„ ìˆ˜ë™ ì—…ë°ì´íŠ¸ ëª…ë ¹ì–´
# SSH ì ‘ì†: ssh root@165.232.95.144

# 1. ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
pm2 delete all
pm2 kill
lsof -ti:5001 | xargs kill -9 2>/dev/null || echo "No process on 5001"

# 2. ìµœì‹  ì½”ë“œ ë‹¤ìš´ë¡œë“œ
cd /var/www
rm -rf hqmx-new
git clone https://github.com/jaykoart/hqmx-backend.git hqmx-new

# 3. í™˜ê²½ ì„¤ì •
cd hqmx-new/backend
cat > .env << 'EOF'
NODE_ENV=production
PORT=5001
API_URL=https://api.hqmx.net
CORS_ORIGIN="https://hqmx.net,https://www.hqmx.net"
BROWSER_HEADLESS=true
BROWSER_TIMEOUT=60000
ENABLE_PROXY_ROTATION=true
PROXY_ROTATION_STRATEGY=performance
USE_PROXY_FOR_YOUTUBE=true
ENABLE_ADVANCED_BYPASS=true
USE_USER_PROFILE_MIMIC=true
BYPASS_MAX_RETRIES=5
BYPASS_TIMEOUT=45000
ENABLE_STEALTH_MODE=true
SIMULATE_HUMAN_BEHAVIOR=true
RATE_LIMIT_MAX_REQUESTS=1000
EOF

# 4. ë¹Œë“œ ë° ì„¤ì¹˜
npm install --production
npm run build

# 5. ì„œë¹„ìŠ¤ êµì²´
cd /var/www
mv hqmx hqmx-old 2>/dev/null || echo "No old directory"
mv hqmx-new hqmx

# 6. ê¶Œí•œ ì„¤ì •
chown -R www-data:www-data hqmx/frontend
chmod -R 755 hqmx

# 7. ì„œë¹„ìŠ¤ ì‹œì‘
cd hqmx/backend
NODE_ENV=production PORT=5001 pm2 start dist/server.js --name hqmx-backend
pm2 save

# 8. ìƒíƒœ í™•ì¸
pm2 status
curl -s http://localhost:5001/health
curl -s https://hqmx.net/api/health

# 9. ê³ ê¸‰ ìš°íšŒ API í…ŒìŠ¤íŠ¸
curl -s https://hqmx.net/api/user-mimic-analyze -X POST \
  -H "Content-Type: application/json" \
  -d '{"url":"https://www.youtube.com/watch?v=jNQXAC9IVRw"}' \
  --max-time 120

echo "âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ!"
